// yangi migratsiya file yaratadi (migrations folder ichida)...
npx knex migrate:make create_tb_users
// yangi seed file yaratadi (seeds folder ichida)...
npx knex seed:make add_users

// development/production yangi migratisya fillarini database ichida yaratib beradi.
npx knex migrate:latest
npx knex migrate:latest --env production

// seeds ichigagi ma'lumotni bazaga default holatda yaratish (seed export qilingan function nomi)
npx knex seed:run

// migratisya qilinganlarni qayta orqaga qaytarish...
// (1 step) / (2 step) 2 ta step qaytadi / (3 step) hammasini qaytaradi
npx knex migrate:rollback
npx knex migrate:rollback --step=2
npx knex migrate:rollback --all

// migratsiya bo'lgan barcha fillarni ko'rsatadi...
npx knex migrate:status

// ++++++++++++++++++++++++++++++++++++++++++++
import type {Knex} from "knex";
import {config} from '../../../config/config';
import path from "path";
import fs from "fs";

const {
    DB_DATA: {
        PGSQL: {
            TABLES: {
                TB_FLOW_PLATFORMS
            },
            SEED_DATA: {
                FLOW_PLATFORMS_PATH
            }
        }
    }
} = config;

export async function up(knex: Knex): Promise<void> {
    try {
        console.log(`Creating ${TB_FLOW_PLATFORMS} table...`);

        await knex.schema.createTable(TB_FLOW_PLATFORMS, (t) => {
            t.increments('id').primary();
            t.string('code', 50).notNullable().unique(); // 'FACEBOOK','INSTAGRAM',...
            t.string('name', 100).notNullable();
            t.jsonb('meta').notNullable().defaultTo('{}'); // e.g. {icon:'fb', auth:'oauth2'}
            t.boolean('is_active').notNullable().defaultTo(true);
            t.integer('weight').notNullable().defaultTo(0);
            t.timestamps(true, true);
        });

        const file_path = path.resolve(__dirname, FLOW_PLATFORMS_PATH);
        const raw_data = fs.readFileSync(file_path, 'utf-8');
        const parsed = JSON.parse(raw_data);

        await knex(TB_FLOW_PLATFORMS).insert(parsed.values);

        // this is trigger for updated_at colum in tb_users
        await knex.raw(`
            CREATE TRIGGER update_${TB_FLOW_PLATFORMS}_updated_at
            BEFORE UPDATE ON ${TB_FLOW_PLATFORMS}
            FOR EACH ROW
            EXECUTE FUNCTION set_updated_at();
        `);

        console.log(`Created ${TB_FLOW_PLATFORMS} table successfully!!!`);
    } catch (e) {
        console.error(`Error creating ${TB_FLOW_PLATFORMS} table:`, e);
    }
}


export async function down(knex: Knex): Promise<void> {
    try {
        await knex.schema.dropTableIfExists(TB_FLOW_PLATFORMS);
    } catch (e) {
        console.error(`Error creating ${TB_FLOW_PLATFORMS} table:`, e);
    }
}
json seed
{
  "values": [
    {
      "code": "FACEBOOK",
      "name": "Facebook",
      "weight": 100
    },
    {
      "code": "INSTAGRAM",
      "name": "Instagram",
      "weight": 90
    },
    {
      "code": "TELEGRAM",
      "name": "Telegram",
      "weight": 80
    },
    {
      "code": "YOUTUBE",
      "name": "YouTube",
      "weight": 70
    },
    {
      "code": "WHATSAPP",
      "name": "WhatsApp",
      "weight": 60
    },
    {
      "code": "OTHER",
      "name": "Other",
      "weight": 0
    }
  ]
}